---
title: "KAS_level"
author: "Gayoung Park"
date: "10/29/2018"
output: html_document
---

```{r setup, include=FALSE}
suppressMessages(library(tidyverse))
library(glue)

# data from PhD data sheet, not KAS sheet.
mydata  <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vRBTqiIHQP1Pg3De1IGsJgVFiJla1dIHyHsGEsSmel8WVAeXXXHmSiyNnQAad9ATdzeukS43WE3PZ2m/pub?gid=0&single=true&output=csv")

# raw material data from KAS data sheet.
kasr <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ9zhSCHjt-1qdSLltD1rhEI_DmaIKtah5yA9WWlsB0gGJWMOYltZR71r00NgkfaYz8YH392oZOWPu/pub?gid=1950751706&single=true&output=csv")

# assemblage composition data from KAS data sheet.
kasa <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ9zhSCHjt-1qdSLltD1rhEI_DmaIKtah5yA9WWlsB0gGJWMOYltZR71r00NgkfaYz8YH392oZOWPu/pub?gid=1138475249&single=true&output=csv")

#volume of the cultural layer from KAS data sheet.
kasv <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ9zhSCHjt-1qdSLltD1rhEI_DmaIKtah5yA9WWlsB0gGJWMOYltZR71r00NgkfaYz8YH392oZOWPu/pub?gid=166963492&single=true&output=csv")

```

I just wanted to make a plot for elevation of each site, and show is there is a relationship between the time of first occupation and elevation, and whether or not there are stemmed points.

We can see that the sites without stemmed points are earlier, and at high elevations. But then after stemmed points appear, the sites without stemmed points are only found at low elevations, and the stem point sites are at higher elevations. So it might suggest that the stemmed point was an important artefact for adapting to high elevations, especially into the period of the Last Glacial Maximum. 

```{r}
mydata_ages <- 
  mydata %>% 
  separate(C14.BP., into = c('age', 'error'),
          sep = "Â±") %>% 
  mutate(age_ka = parse_number(age) / 1000,
         error = parse_number(error)) %>% 
  mutate(has_sp = ifelse(!is.na(SP.), "yes", "no"))

ggplot(mydata_ages, 
       aes(x = age_ka,
           y = altitude.m._of_main_layer,
       color = as.factor(has_sp))) +
  geom_point(size = 3) +
  xlab("Age of occupation (ka)") +
  ylab("Elevation above sea level (m)") +
  geom_smooth(se = FALSE) +
  scale_colour_discrete(name = "Contains\nstemmed\npoints?") +
  theme_minimal(base_size = 16) 
```

Using raw material information sheeet from KAS data sheets.

```{r}
kasr_long <- 
  kasr %>% 
  gather(site, 
         count, 
         -X) %>% 
  group_by(site) %>% 
  mutate(percentage = count / sum(count, na.rm = TRUE) * 100,
         total = sum(count, na.rm = TRUE)) %>% 
  filter(!is.na(percentage)) %>% 
  # if percentage is <10%, call it 'other'
  mutate(raw_material = ifelse(percentage >= 10, as.character(X), "other")) %>% 
  mutate(axis_label = glue('{site}\n(n = {total})')) %>% 
  # join to get ages of the sites
  left_join(mydata_ages, 
            by = c('site' = 'site_name')) %>% 
  arrange(age_ka)


ggplot(kasr_long, 
       aes(age_ka,
           percentage,
           fill = raw_material)) +
  geom_col() +
  xlab("Age of assemblage (ka)") +
  ylab("Percentage") +
  scale_fill_viridis_d(name = "Raw material type") +
  theme_minimal(base_size = 16) 
```

The following plot is representing the artifact composition of each sites to figure out what people did as they were occupying the sites.

```{r}
kasa_long <-
  kasa %>%
  gather(site, 
         count, 
         -X) %>% 
  filter(!is.na(count)) %>% 
  group_by(site) %>% 
  mutate(percentage = count / sum(count, na.rm = TRUE) * 100,
         total = sum(count, na.rm = TRUE)) %>% 
  filter(!is.na(percentage)) %>% 
  # if percentage is <10%, call it 'other'
  mutate(artefact_type = ifelse(as.character(X) == 'stemmed_point',
                                'stemmed_point', 
                                ifelse(percentage >= 10, 
                                as.character(X), "other"))) %>% 
  mutate(axis_label = glue('{site}\n(n = {total})'))  %>% 
  # join to get ages of the sites
  left_join(mydata_ages, 
            by = c('site' = 'site_name')) %>% 
  arrange(age_ka)

ggplot(kasa_long, 
       aes(age_ka, 
           percentage,
           fill = artefact_type)) +
  geom_col() +
  xlab("") +
  ylab("Percentage") +
  xlab("Age of assemblage (ka)") +
  scale_fill_viridis_d(name = "Artifact type")  +
  theme_minimal(base_size = 16) 
```

Volume and artefact counts to get density over time. I think we need to have a plot of density by retouched pieces, isn't that what Barton et al have?


```{r}
kasv_tidy <- 
kasv %>% 
  t %>% 
  as_tibble() %>% 
  setNames(as.character(.[1,])) %>% 
  .[-1,] %>% 
  mutate_all(parse_number) %>% 
  mutate(artefact_density = total_artifacts / volume,
         sites = names(kasv)[-1])

library(ggrepel)
ggplot(kasv_tidy,
       aes(date_age,
           artefact_density)) +
  geom_point(aes(size = total_artifacts)) +
  geom_text_repel(aes(label = sites),
                  nudge_x = 0.25, 
                  nudge_y = 0.25) +
  theme_minimal(base_size = 16)

```

